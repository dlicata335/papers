\section{Judgments}

We have fewer judgments:

\paragraph{Coherences}

\begin{small}
\begin{itemize}
\item $\wfdiagctx{\diag\Gamma}$
\item $\wfdiag{\Delta}$
\item $\wfdiaglob{\diag\Gamma}{\diag G}n$ (requires $\wfdiagctx{\diag\Gamma}$)
\item $\ofdiaglob{\diag\Gamma}{\diag M}{\diag G}$
(requires $\wfdiaglob{\diag\Gamma}{\diag G}n$)
\item $\substdiaglob{\diag\Gamma}{\diag \delta}{\diag{\Gamma'}}$
(requires $\wfdiagctx{\diag\Gamma}$ and $\wfdiagctx{\diag{\Gamma'}}$)
\end{itemize}
\end{small}

%\paragraph{Basics}
%\begin{small}
%\begin{itemize}
%\item $\wfsub{\Gamma}{\theta}{\Gamma'}$ (requires $\wfctx{\Gamma}$ and
%      $\wfctx{\Gamma'}$)
%\end{itemize}
%\end{small}

\paragraph{Types}

\begin{small}
\begin{itemize}
\item $\wfctx{\Gamma}$
\item $\wftp{\Gamma}{A}$
\item $\oftp{\Gamma}{M}{A}$ (requires $\wftp{\Gamma}{A}$)
\end{itemize}
\end{small}

%% \paragraph{Diagram interpretation and dependent globs}

%% \begin{small}
%% \begin{itemize}
%% \item $\ofinterp{\Gamma}{\delta}{\diag\Gamma}{\tel A}$
%% (requires $\wfdiagctx{\diag\Gamma}$ and $\wftel{\Gamma}{\tel A}$)
%% \item $\ofinterpdep{\Gamma}{\eta}{\diag\Gamma}{\tel A.B}{\delta}$
%% (requires $\ofinterp{\Gamma}{\delta}{\diag\Gamma}{\tel A}$
%% and $\ofinterpdep{\Gamma}{\eta}{\diag\Gamma}{\tel A.B}{\delta}$)
%% \item $\wfdepglob{\Gamma}{H}{\tel A.B}{\tel G}$
%% (requires $\wfglob{\Gamma}{\tel G}{\tel A}n$ and $\wftype{\Gamma,\teltm xA}{B}$)
%% \item $\ofdepglob{\Gamma}{N}{H}{\tel M}$
%% (requires $\wfdepglob{\Gamma}{H}{\tel A.B}{\tel G}$
%% and $\ofglob{\Gamma}{\tel M}{\tel G}$)
%% \end{itemize}
%% \end{small}

\section{Diagram calculus}

\subsection{Contexts}

\begin{small}
  \[
  \infer{\wfdiagctx{\emptyctx}}{}
  \qquad\qquad
  \infer
  {\wfdiagctx{\diag\Gamma,\tptm{x}{\diag G}}}
  {\wfdiagctx{\diag\Gamma} & \wfdiagtp{\diag\Gamma}{\diag G}}\]
\end{small}

\subsection{Diagrams (contractible contexts)}

\begin{small}
  \[
  \infer{\wfdiag{\tptm{x}{\diagbase}}}{}
  \qquad\qquad
  \infer{\wfdiag{\Delta,\tptm{y}{\diagbase},\tptm{p}{\iid{\diagbase}{x}{y}}}}
  {(\tptm{x}{\diagbase}) \in \Delta}\]
\end{small}

\subsection{Types}

\begin{small}
  \[
  \infer{\wfdiagtp{\diag\Gamma}{\diagbase}}{}
  \qquad
  \infer
    {\wfdiagtp{\diag\Gamma}{\iid{\diagbase}{\diag{M_1}}{\diag{M_2}}}}
    {\ofdiagtp{\diag\Gamma}{\{\diag{M_1},\diag{M_2}\}}{\diagbase}}
  \qquad
  \infer
    {\wfdiagtp{\diag\Gamma}{\iid{\iid{\diagbase}{\diag{M_1}}{\diag{M_2}}}{\diag{N_1}}{\diag{N_2}}}}
    {\ofdiagtp{\diag\Gamma}{\{\diag{M_1},\diag{M_2}\}}{\diagbase}
    &\ofdiagtp{\diag\Gamma}{\{\diag{N_1},\diag{N_2}\}}{\iid{\diagbase}{\diag{M_1}}{\diag{M_2}}}}
  \]
\end{small}

\subsection{Terms}

\begin{small}
  \[
  \infer{\ofdiaglob{\diag\Gamma}{x}{\diag G}}
        {(\tptm{x}{\diag G})\in\diag\Gamma}
  \qquad\qquad
  \def\diagG{\iid{\diagbase}{\diag{M_1}}{\diag{M_2}}}
  \infer{\ofdiaglob{\diag\Gamma}{\diagcoh{\Delta.\diagG}{\diag\delta}}{(\diagG)[\diag\delta]}}
        {\wfdiag{\Delta} 
        &\wfdiagtp{\Delta}{\diagG}
        &\substdiaglob{\diag\Gamma}{\diag\delta}{\Delta}}
  \]
  \\
  \[
  \def\diagG{\iid{(\iid{\diagbase}{\diag{M_1}}{\diag{M_2}})}{\diag{N_1}}{\diag{N_2}}}
  \infer{\ofdiaglob{\diag\Gamma}{\diagcoh{\Delta.\diagG}{\diag\delta}}{(\diagG)[\diag\delta]}}
        {\wfdiag{\Delta} 
        &\wfdiagtp{\Delta}{\diagG}
        &\substdiaglob{\diag\Gamma}{\diag\delta}{\Delta}}
  \]
\end{small}

\subsection{Substitutions}

\begin{small}
  \[
  \infer{\substdiaglob{\diag\Gamma}{()}{\emptyctx}}
  {}
  \qquad
  \infer{\substdiaglob{\diag\Gamma}{(\diag \delta,\diag N/x)}
    {(\diag{\Gamma'},\tptm{x}{\diag G})}}
  {\substdiaglob{\diag\Gamma}{\diag \delta}{\diag{\Gamma'}}
    & \ofdiaglob{\diag\Gamma}{\diag N}{\tsubst{\diag G}{\diag \delta}}}
  \]
\end{small}

\section{Type theory}

\subsection{Contexts}

\begin{small}
  \[
  \infer{\wfctx{\varnothing}}{}
  \qquad\qquad
  \infer{\wfctx{\Gamma,x:A}}
  {\wfctx{\Gamma}
    & \wftype{\Gamma}{A}
    & (x\not\in\Gamma)}
  \]
\end{small}

\subsection{Types}

\begin{small}
\[
\begin{array}{l}
\infer{\wftp{\Gamma}{\picl{x}{A}{B}}}
      {\wftp{\Gamma}{A} & \wftp{\Gamma,\tptm{x}{A}}{B}}
\qquad
\infer{\wftp{\Gamma}{\sigmacl{x}{A}{B}}}
      {\wftp{\Gamma}{A} & \wftp{\Gamma,\tptm{x}{A}}{B}}
\qquad
\infer{\wftp{\Gamma}{1}}{}
\\ \\ 
\infer{\wftp{\Gamma}{\set}}{}
\qquad
\infer{\wftp{\Gamma}{\el{S}}}{\oftp{\Gamma}{S}{\set}}
\\ \\
\infer{\wftp{\Gamma}{\iid{A}{M_1}{M_2}}}
      {\wftp{\Gamma}{A} &
       \oftp{\Gamma}{M_1}{A} & 
       \oftp{\Gamma}{M_2}{A}}
\qquad
\infer{\wftp{\Gamma}{\iidover{x.B}{\alpha}{N_1}{N_2}}}
      {\begin{array}{l}
       \wftp{\Gamma}{A} \qquad
       \oftp{\Gamma}{\{M_1,M_2\}}{A}  \qquad
       \oftp{\Gamma}{\alpha}{\iid{A}{M_1}{M_2}} \\ 
       \oftp{\Gamma}{N_1}{\subst{B}{M_1}{x}} \qquad
       \oftp{\Gamma}{N_1}{\subst{B}{M_2}{x}} 
        \end{array}
        }
\\ \\
\infer{\wftp{\Gamma}{\sone}}{}
\qquad
\infer{\wftp{\Gamma}{\sm{A}{B}}}{\wftp{\Gamma}{A} & \wftp{\Gamma}{B}}
\end{array}
\]
\end{small}

\subsection{Type Equalities}

\newcommand{\whnf}[1]{\ensuremath{\underbar{\ensuremath{#1}}}}
\newcommand{\neu}[1]{\ensuremath{\overline{\ensuremath{#1}}}}
\newcommand{\hd}[1]{\ensuremath{\mathit{hd}(#1)}}
\newcommand{\equivset}[2]{\ensuremath{#1 \cong #2}}

WHNFs:
\[
\begin{array}{rcl}
G\ep & ::= & {\sone} \mid \sm{A}{B} \mid {\iid{G\ep}{M}{N}} \\
\neu{A}  & ::= & \el{\neu{M}} \mid \iid{\neu{A}}{M}{N} \mid {\iidover{x.\neu{B}}{\alpha}{M}{N}} \text{(when $\hd{\neu B} \neq x$)} \\
\whnf{A} & ::= & G\ep \mid \neu{A} \mid \picl{x}{A}{B} \mid \sigmacl{x}{A}{B} \mid \unit \mid \set \\
\end{array}
\]

All of these are really typed definitional equality rules, but we write
them algorithmically:

\begin{small}
\[
\begin{array}{rclll}
\el{S} & \mapsto & \el{S'} & \text{if} & S \mapsto S' \\
\el{\picd{S}{T}} & \mapsto & \picl{x}{\el{S}}{\el{\app T x}} \\
\el{\sigmacd{S}{T}} & \mapsto & \sigmacl{x}{\el{S}}{\el{\app T x}} \\
\el{\unitcd} & \mapsto & \unit \\
\el{\smcd{S}{T}} & \mapsto & \sm{\el{S}}{\el{T}} \\
\el{\idcd{S}{M}{N}} & \mapsto & \iid{\el{S}}{M}{N} 
\\ \\

\iid{A}{M}{N} & \mapsto & \iid{A'}{M}{N} & \text{if} & A \mapsto A' \\
\iid{\picl{x}{A}{B}}{M}{N} & \mapsto & \picl{x}{A}{\iid{B}{\app M x}{\app N x}} & \\
\iid{\sigmacl{x}{A}{B}}{M}{N} & \mapsto & \sigmacl{p}{\iid{A}{\fst M}{\fst N}}{\iidover{x.B}{p}{\snd M}{\snd N}} & \\
\iid{\unit}{M}{N} & \mapsto & \unit \\
\iid{\set}{S}{T} & \mapsto & \equivset{S}{T} 
\\ \\

\iidover{x.B}{\alpha}{M}{N} & \mapsto & \iidover{x.B'}{\alpha}{M}{N} & \text{if} & \tptm{x}{A} \vdash B \mapsto B'\\
\iidover{x.\picl{y}{B}{C}}{\tptm{\alpha}{\iid{}{M_1}{M_2}}}{N_1}{N_2} & \mapsto
& \picl{y_1}{\subst{B}{M_1}{x}}{\picl{y_2}{\subst{B}{M_2}{x}}{\picl{p}{\iidover{x.B}{\alpha}{y_1}{y_2}}{\iidover{(x,y).C}{(\alpha,p)}{\app{N_1}{y_1}}{\app{N_2}{y_2}}}}} \\
\iidover{x.\sigmacl{y}{B}{C}}{\alpha}{N_1}{N_2} & \mapsto & \sigmacl{p}{\iidover{x.B}{\alpha}{\fst{N_1}}{\fst{N_2}}}{\iidover{(x,y).C}{(\alpha,p)}{\snd{N_1}}{\snd{N_2}}} \\
\iidover{x.\unit}{\alpha}{N_1}{N_2} & \mapsto & \iid{\unit}{N_1}{N_2} \\
\iidover{x.\set}{\alpha}{N_1}{N_2} & \mapsto & \iid{\set}{N_1}{N_2} \\
\iidover{x.G\ep}{\alpha}{N_1}{N_2} & \mapsto & \iid{}{\transport{x.G\ep}{\alpha}{N_1}}{N_2} \\
\iidover{x.\neu{A}}{\alpha}{N_1}{N_2} & \mapsto &
\iid{}{\transport{x.\neu{A}}{\alpha}{N_1}}{N_2} & \text{if} & \hd{\neu{A}} = x\\
\end{array}
\]
\end{small}

Admissible rules:

\[
\infer{\deqtp{\Gamma}{\iidover{(x,y).B}{(\alpha,\ap{x.M}{\alpha})}{N_1}{N_2}}
                     {\iidover{x.\subst{B}{M}{y}}{\alpha}{N_1}{N_2}}}
      {}
\]

\FIXME{what primitive rules do we need to make these admissible?}

Note:
\[
\infer{\deqtp{\Gamma}{\iidover{x.B}{\alpha}{N_1}{N_2}}
                     {\iid{B}{N_1}{N_2}}}
      {x \# B}
\]
doesn't work because it equates single funext with triple funext.  

Guiding principle for what rules we add:
reduction should be stable under substitution: \\
If $x \vdash M \mapsto M'$ then $\subst{M}{N}{x} \mapsto
\subst{M'}{N}{x}$.  

\subsection{Interpretation of diagram contexts}

(FIXME: should A be an open type?)

We have meta-operations $\interpdiag{\diag\Gamma}{A}$, $\interpdiag{\diag
G}{A}$, $\interpdiag{\diag M}{A}$ of the following types:
\begin{small}
\[
\infer{\wfctx{\interpdiag{\diag\Gamma}{A}}}
      {\wfdiagctx{\diag\Gamma} & \wftp{}{A}}
\qquad\qquad
\infer{\wftp{\interpdiag{\diag\Gamma}{A}}{\interpdiag{\diag G}{A}}}
      {\wfdiagtp{\diag\Gamma}{\diag G} & \wftp{}{A}}
\qquad\qquad
\infer{\oftp{\interpdiag{\diag\Gamma}{A}}{\interpdiag{\diag M}{A}}{\interpdiag{\diag G}{A}}}
      {\oftp{\diag\Gamma}{\diag M}{\diag G} & \wftp{}{A}}
\]
\end{small}

% TODO

\begin{small}
\[\begin{aligned}
\interpdiag{\emptyctx}{A} &:= \emptyctx \\
\interpdiag{\diag\Gamma,\tptm{x}{\diag G}}{A} &:=
\interpdiag{\diag\Gamma}{A},\tptm{x}{\interpdiaglob{\diag G}{A}} \\
&\\
\interpdiag{\diagbase}{A} &:= A \\
\interpdiag{\iid{\diag G}{\diag M}{\diag N}}{A} &:= \iid{\interpdiag{\diag
G}{A}}{\interpdiag{\diag M}A}{\interpdiag{\diag N}A} \\
&\\
\interpdiag{x}{A} &:= x \\
\interpdiag{\diagcoh{\Delta.\diag G}{\diag\delta}}{A} &:= 
\coh{\Delta.\diag G}{A}{\diag\delta}
\end{aligned}\]
\end{small}

\subsection{Terms}

\begin{small}
\[
\begin{array}{l}
% pi
\infer{\oftp{\Gamma}{\lam{x}{A}{M}}{\picl{x}{A}{B}}}
      {\oftp{\Gamma,\tptm{x}{A}}{M}{B}}
\qquad
\infer{\oftp{\Gamma}{\app{M}{N}}{\subst{B}{N}{x}}}
      {\oftp{\Gamma}{M}{\picl{x}{A}{B}} & \oftp{\Gamma}{N}{A}}
\\ \\
% sigma
\infer{\oftp{\Gamma}{\pair{M}{N}}{\sigmacl{x}{A}{B}}}
      {\wftp{\Gamma,\tptm{x}{A}}{B} &
       \oftp{\Gamma}{M}{A} & \oftp{\Gamma}{N}{\subst{B}{M}{x}}}
\qquad
\infer{\oftp{\Gamma}{\fst{M}}{A}}
      {\oftp{\Gamma}{M}{\sigmacl{x}{A}{B}}}
\qquad
\infer{\oftp{\Gamma}{\snd{M}}{\subst{B}{\fst{M}}{x}}}
      {\oftp{\Gamma}{M}{\sigmacl{x}{A}{B}}}
\\ \\
% unit
\infer{\oftp{\Gamma}{\mt}{\unit}}
      {}
\qquad
\infer{\oftp{\Gamma}{\unitind{M}{N}}{\subst{C}{M}{x}}}
      {\wftp{\Gamma,\tptm x\unit}{C} &
       \oftp{\Gamma}{M}{\unit} & \oftp{\Gamma}{N}{\subst{C}{\mt}{x}}}
\\ \\
% sum
\infer{\oftp{\Gamma}{\inl{M}}{\sm{A}{B}}}
      {\oftp{\Gamma}{M}{A}}
\qquad
\infer{\oftp{\Gamma}{\inr{M}}{\sm{A}{B}}}
      {\oftp{\Gamma}{M}{B}}
\\ \\
\infer{\oftp{\Gamma}{\smind{\sm{A}{B}}{M}{y.N_1}{z.N_2}}{\subst{C}{M}{x}}}
      {\wftp{\Gamma,\tptm{x}{\sm{A}{B}}}{C} &
       \oftp{\Gamma}{M}{\sm{A}{B}} &
       \oftp{\Gamma,\tptm{y}{A}}{N_1}{\subst{C}{\inl{y}}{x}} &
       \oftp{\Gamma,\tptm{z}{B}}{N_2}{\subst{C}{\inr{z}}{x}}}
\\ \\
% set
\infer{\oftp{\Gamma}{\picd{S}{T}}{\set}}
      {\oftp{\Gamma}{S}{\set} & \oftp{\Gamma}{T}{\set\to\set}} %FIXME ??
\qquad
\infer{\oftp{\Gamma}{\sigmacd{S}{T}}{\set}}
      {\oftp{\Gamma}{S}{\set} & \oftp{\Gamma}{T}{\set\to\set}} %FIXME ??
\qquad
\infer{\oftp{\Gamma}{\unitcd}{\set}}{}
\\ \\ 
\infer{\oftp{\Gamma}{\idcd{S}{M_1}{M_2}}{\set}}
      {\oftp{\Gamma}{S}{\set} &
       \oftp{\Gamma}{M_1}{\el{S}} & 
       \oftp{\Gamma}{M_2}{\el{S}}}
\qquad
\infer{\oftp{\Gamma}{\smcd{S}{T}}{\set}}
      {\oftp{\Gamma}{S}{\set} & \oftp{\Gamma}{T}{\set}}
\end{array}
\]
\end{small}

\paragraph{\sone}

\begin{small}
\[
\begin{array}{l}
\infer{\oftp{\Gamma}{\base}{\sone}}{}
\qquad
\infer{\oftp{\Gamma}{\lp}{\iid{\sone}{\base}{\base}}}{}
\\ \\
\infer{\oftp{\Gamma}{\sind{M}{b}{\ell}}{\subst{C}{M}{x}}}
      {\wftp{\Gamma,\tptm{x}{\sone}}{C}
      &\oftp{\Gamma}{M}{\sone}
      &\oftp{\Gamma}{b}{\subst{C}{\base}{x}}
      &\oftp{\Gamma}{\ell}{\iidover{x.C}{\lp}{b}{b}}}
\end{array}
\]
\end{small}

\paragraph{Coh}

\begin{small}
\[
\begin{array}{l}
\infer
  {\oftp{\interpdiag{\diag\Gamma}{A}}
        {\coh{\Delta.\diag G}{A}{\diag\delta}}
        {\interpdiag{\diag G[\diag\delta]}{A}}}
  {\wftp{}{A}
  &\oftp{\diag\Gamma}{\diagcoh{\Delta.\diag G}{\diag\delta}}{\diag
    G[\diag\delta]}}
\end{array}
\]
\end{small}


\paragraph{Ap}
\begin{small}
\[
\begin{array}{l}
\infer{\oftp{\Gamma}{\ap{(x.M)}{N}}{\iidover{x.B}{N}{\subst{M}{N_1}{x}}{\subst{M}{N_2}{x}}}}
      {\oftp{\Gamma,\tptm{x}{A}}{M}{B} & \oftp{\Gamma}{N}{\iid{A}{N_1}{N_2}}}
\end{array}
\]
\end{small}

\paragraph{Transport}

\ \\
(Do we want inverse transport?)

\begin{small}
\[
\begin{array}{l}
\infer{\oftp{\Gamma}{\transport{x.B}{M}{N}}{\subst{B}{M_2}{x}}}
      {\wftp{\Gamma,\tptm{x}{A}}{B} &
       \oftp{\Gamma}{M}{\iid{A}{M_1}{M_2}} &
       \oftp{\Gamma}{N}{\subst{B}{M_1}{x}}}
\\ \\
\infer{\oftp{\Gamma}{\transportinv{x.B}{M}{N}}{\subst{B}{M_1}{x}}}
      {\wftp{\Gamma,\tptm{x}{A}}{B} &
       \oftp{\Gamma}{M}{\iid{A}{M_1}{M_2}} &
       \oftp{\Gamma}{N}{\subst{B}{M_2}{x}}}
\end{array}
\]
\end{small}

transport/pathover equivalences

depcoh and factoring

apcoh or something that implies it (only on refl?)

\subsection{Equations for Terms}

\begin{small}
\[
\begin{array}{l}
\neu{A} ::= \ap{(x.y)}{\alpha} \text{ when $x \# y$ } \mid \\
\end{array}
\]
\end{small}

\begin{small}
\[
\begin{array}{rclll}
\ap{(x.M)}{\alpha} & \mapsto & \ap{(x.M')}{\alpha} & \text{if} & x \vdash M \mapsto M'\\ 
\ap{(x.x)}{\alpha} & \mapsto & \text{some adjustment of $\alpha$} & & \text{requires pathover in constant fib to be constant}\\ 
\ap{(x.\ulam{y}{M})}{\alpha} & \mapsto & \ulam{y_1}{\ulam{y_2}{\ulam{p}{\ap{((x,y).M)}{(\alpha,p)}}}}\\
\ap{(x.\app M N)}{\alpha} & \mapsto & \apppp {(\ap{(x.M)}{\alpha})}{\_}{\_}{(\ap{(x.N)}{\alpha})} & &\text{requires reassoc to type check}\\ 
\ap{(x.(M,N))}{\alpha} & \mapsto & (\ap{(x.M)}{\alpha}, \ap{(x.N)}{\alpha}) & & \text{requires reassoc to type check}\\ 
\ap{(x.\fst M)}{\alpha} & \mapsto & \fst {(\ap{(x.M)}{\alpha})} & & \\ 
\ap{(x.\snd M)}{\alpha} & \mapsto & \snd {(\ap{(x.M)}{\alpha})} & & \text{requires reassoc and previous rule to type check}\\ 
\ap{(x.\mt)}{\alpha} & \mapsto & \mt & \\ 
\end{array}
\]
\end{small}

For elements of \set, can just use transport at unfolding of $El$?  

Would be nice, but probably only propositionally true, without adding a
critical pair:
\[
\infer{\deqtm{\Gamma}{\transport{x.B}{\alpha}{N_1}}{N_2}{}}
      {x \# B}
\]
Does it need to be a generic program giving a path?

\subsection{Open questions}

Do we want $\ap{(x.\mt)}{\alpha}$ to be neutral?

